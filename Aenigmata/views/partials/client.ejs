<script>

    var jsonCourant = "";

    var tempsAttenteReponse = 1000;
    var tempsAttenteProchaineEnigme = 1000;
    var enAttente = false;
    
    var tempsAttenteChangerLangue = 1000;
    var enAttenteLangue = false;

    const CAPTEUR_VIDE = "NULL";
    var capteurCourant = "";

    var timerProchaineEnigme;
    var timerRepondre;
    var timerChangerLangue;

    //vues
    var idEnigme = document.getElementById('idEnigme');
    var categorie = document.getElementById('categorie');
    var question = document.getElementById('question');
    var explication = document.getElementById('explication');
    var image = document.getElementById('image');
    var video = document.getElementById('video');

    var reponseA = document.getElementById('reponseA');
    var reponseB = document.getElementById('reponseB');
    var reponseC = document.getElementById('reponseC');

    var boutonA = document.getElementById('boutonA');
    var boutonB = document.getElementById('boutonB');
    var boutonC = document.getElementById('boutonC');
    
    var radioFR = document.getElementById('fr');
    var radioDE = document.getElementById('de');
    var radioEN = document.getElementById('en');
    
    var tutorielFR = document.getElementById('tutorielFR');
    var tutorielDE = document.getElementById('tutorielDE');
    var tutorielEN = document.getElementById('tutorielEN');

    //initialisation
    radioFR.click();
    addListeners();
    enAttente = false;
    enAttenteLangue = false;
    capteurCourant = CAPTEUR_VIDE;
    langueCourante = "FR";
        
    image.style.display = "none";
    video.style.display = "none";
    explication.style.visibility = "hidden";
    tutorielDE.style.display = "none";
    tutorielEN.style.display = "none";
    
    //rafraichit la vue la première fois
    var erreursVue = false;
    fetch('/suivant', {
        method: 'post',
        headers: { 'Content-Type': 'application/json' },
        })
        .then(res => res.json())
        .then(json => stockerJson(json));

    //fonctions
    function addListeners(){
        reponseA.addEventListener("click", repondre);
        reponseA.valeur = "A";
        reponseB.addEventListener("click", repondre);
        reponseB.valeur = "B";
        reponseC.addEventListener("click", repondre);
        reponseC.valeur = "C";
        
        radioFR.addEventListener("click", changerLangue);
        radioFR.valeur = "FR";
        radioDE.addEventListener("click", changerLangue);
        radioDE.valeur = "DE";
        radioEN.addEventListener("click", changerLangue);
        radioEN.valeur = "EN";
    };

    function removeListeners(){
        reponseA.removeEventListener("click", repondre);
        reponseB.removeEventListener("click", repondre);
        reponseC.removeEventListener("click", repondre);
        
        radioFR.removeEventListener("click", changerLangue);
        radioDE.removeEventListener("click", changerLangue);
        radioEN.removeEventListener("click", changerLangue);
    };

    function stockerJson(json)
    {
        console.log(json);
        jsonCourant = json;
        
        rafraichirVue();
    }

    function rafraichirVue()
    {
        var json = jsonCourant;
        console.log("RAFRAICHIRVUE: " + json);
        
        // afficher les fichiers avec erreurs la première fois
        if(!erreursVue && json.fichiersErreur != "")
        {
            let fichiersErreurString = "\n";
            for(var i = 0; i < json.fichiersErreur.length; i++)
            {
                fichiersErreurString += json.fichiersErreur[i] + "\n";
            };
            window.alert("Les énigmes suivantes ont des erreurs: " + fichiersErreurString);
            erreursVue = true;
        }
        
        idEnigme.innerHTML = json.id;            
        reponseA.className = json.reponses[0].value;
        reponseB.className = json.reponses[1].value;
        reponseC.className = json.reponses[2].value;
        
        if(json.cheminImage != "")
        {
            image.setAttribute("src", json.cheminImage);
            image.style.display = "initial";
        } else {
            image.style.display = "none";
        }
        
        if(json.cheminVideo != "")
        {
            video.setAttribute("src", json.cheminVideo);
            video.style.display = "initial";
        } else {
            video.style.display = "none";
        }
        
        if(langueCourante == "DE")
        {
            //Allemand
            if(json.questionDE !== undefined)
            {
                categorie.innerHTML = json.categorieDE;
                question.innerHTML = json.questionDE;
                explication.innerHTML = json.explicationDE;
                
                boutonA.innerHTML = json.reponsesDE[0].name;
                boutonB.innerHTML = json.reponsesDE[1].name;
                boutonC.innerHTML = json.reponsesDE[2].name;
            }
            
            tutorielFR.style.display = "none";
            tutorielDE.style.display = "initial";
            tutorielEN.style.display = "none";
        } else if (langueCourante == "EN")
        {
            //Anglais
            if(json.questionEN !== undefined)
            {
                categorie.innerHTML = json.categorieEN;
                question.innerHTML = json.questionEN;
                explication.innerHTML = json.explicationEN;

                boutonA.innerHTML = json.reponsesEN[0].name;
                boutonB.innerHTML = json.reponsesEN[1].name;
                boutonC.innerHTML = json.reponsesEN[2].name;
            }

            tutorielFR.style.display = "none";
            tutorielDE.style.display = "none";
            tutorielEN.style.display = "initial";
        } else {
            //Francais par defaut
            
            categorie.innerHTML = json.categorie;
            question.innerHTML = json.question;
            explication.innerHTML = json.explication;

            boutonA.innerHTML = json.reponses[0].name;
            boutonB.innerHTML = json.reponses[1].name;
            boutonC.innerHTML = json.reponses[2].name;
            
            tutorielFR.style.display = "initial";
            tutorielDE.style.display = "none";
            tutorielEN.style.display = "none";
        }

        
        addListeners();

        rafraichirFeedback();
    };

    function feedback(){
        if(reponseA.classList.contains("true")) {
            boutonA.className = "true";
        } else {
            boutonA.className = "false";
        }

        if(reponseB.classList.contains("true")) {
            boutonB.className = "true";
        } else {
            boutonB.className = "false";
        }

        if(reponseC.classList.contains("true")) {
            boutonC.className = "true";
        } else {
            boutonC.className = "false";
        }

        explication.style.visibility = "visible";
    };

    function rafraichirFeedback()
    {
        boutonA.className = "default";
        boutonB.className = "default";
        boutonC.className = "default";
        explication.style.visibility = "hidden";
    }

    function prochaineEnigme()
    {
        if(enAttente) 
        {
            console.log("PROCHAINE ENIGME: en attente");
            return;
        }

        enAttente = true;

        timerProchaineEnigme = setTimeout(() => {
            fetch('/suivant', {
                method: 'post',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(res => res.json())
            .then(json => stockerJson(json))

            enAttente = false;
        }, tempsAttenteProchaineEnigme);
    };


    function repondre(event)
    {
        if(enAttente) 
        {
            console.log("REPONSE: en attente");
            return;
        }

        enAttente = true;
        
        var reponse = event.currentTarget.valeur;
        console.log("REPONSE: " + reponse);

        if(reponse == "A") 
        {
            boutonA.className = "pressed";
        } else if (reponse == "B") {
            boutonB.className = "pressed";
        } else if (reponse == "C") {
            boutonC.className = "pressed";
        }
        
        timerRepondre = setTimeout(() => {
            feedback();
            removeListeners();

            enAttente = false;
        }, tempsAttenteReponse);
    };
    
    function changerLangue(event)
    {
        if(enAttenteLangue) 
        {
            console.log("CHANGERLANGUE: en attente");
            return;
        }

        enAttenteLangue = true;
        
        var valeur = event.currentTarget.valeur;
        langueCourante = valeur;
        console.log("CHANGERLANGUE: " + valeur);
        
        timerChangerLangue = setTimeout(() => {
        
            enAttenteLangue = false;
            rafraichirVue();
        }, tempsAttenteChangerLangue);
        
    };

    //socket.io    
    const socket = io();

    socket.on('capteurON', function(capteur) {
        console.log("[EVENT] capteurON: " + capteur);
        
        if(capteur == "Langue")
        {
            if(!enAttenteLangue)
            {
                if(langueCourante == "FR")
                {
                    radioDE.click();
                } else if(langueCourante == "DE")
                {
                    radioEN.click();
                } else if(langueCourante == "EN")
                {
                    radioFR.click();
                }
            }
        } else {
            if(capteurCourant == CAPTEUR_VIDE)
            {
                capteurCourant = capteur;
                if(capteur == "A")
                {
                    reponseA.click();
                } else if(capteur == "B")
                {
                    reponseB.click();
                } else if(capteur == "C")
                {
                    reponseC.click();
                } else {
                    capteurCourant = CAPTEUR_VIDE;
                    console.log("[EVENT] Erreur, capteur non reconnu");
                }
                console.log("capteur courant: " + capteurCourant);
            } else {
                console.log("capteur pas vide: " + capteurCourant + " capteur : " + capteur);
            }
        }
    });

    socket.on('capteurOFF', function(capteur) {
        console.log("[EVENT] capteurOFF: " + capteur);
        
        if(capteur == "Langue")
        {
        
        } else {
            console.log("capteur courant: " + capteurCourant);

            if(capteurCourant != CAPTEUR_VIDE) {
                if(capteur == capteurCourant) {
                    if(enAttente)
                    {
                        clearTimeout(timerRepondre);
                        feedback();
                        removeListeners();
                        enAttente = false;
                    }

                    prochaineEnigme();
                    capteurCourant = CAPTEUR_VIDE;
                    console.log("RESET: " + capteurCourant);
                }
            }

            /*
            if(capteur == "A")
            {
                prochaineEnigme();
            } else if(capteur == "B")
            {
                prochaineEnigme();
            } else if(capteur == "C")
            {
                prochaineEnigme();
            } else {
                console.log("[EVENT] Erreur, capteur non reconnu");
            }
            */
        }
        
    });

</script>
