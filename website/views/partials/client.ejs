<script>

    var tempsAttente = 1000;
    var enAttente = false;

    //vues
    var idEnigme = document.getElementById('idEnigme');
    var categorie = document.getElementById('categorie');
    var question = document.getElementById('question');
    var explication = document.getElementById('explication');
    var image = document.getElementById('image');

    var reponseA = document.getElementById('reponseA');
    var reponseB = document.getElementById('reponseB');
    var reponseC = document.getElementById('reponseC');

    var boutonA = document.getElementById('boutonA');
    var boutonB = document.getElementById('boutonB');
    var boutonC = document.getElementById('boutonC');

    //initialisation
    addListeners();
    enAttente = false;

    //fonctions
    function addListeners(){
        reponseA.addEventListener("click", repondre);
        reponseA.valeur = "A";
        reponseB.addEventListener("click", repondre);
        reponseB.valeur = "B";
        reponseC.addEventListener("click", repondre);
        reponseC.valeur = "C";
    };

    function removeListeners(){
        reponseA.removeEventListener("click", repondre);
        reponseB.removeEventListener("click", repondre);
        reponseC.removeEventListener("click", repondre);
    };

    function rafraichirVue(json)
    {
        console.log(json);

        idEnigme.innerHTML = json.id;
        categorie.innerHTML = json.categorie;
        question.innerHTML = json.question;
        explication.innerHTML = json.explication;
        boutonA.innerHTML = json.reponses[0].name;
        boutonB.innerHTML = json.reponses[1].name;
        boutonC.innerHTML = json.reponses[2].name;
        image.setAttribute("src", json.cheminImage);

        addListeners();

        rafraichirFeedback();
    };

    function feedback(){
        if(reponseA.classList.contains("true")) {
            boutonA.style.backgroundColor = "green";
        } else {
            boutonA.style.backgroundColor = "red";
        }

        if(reponseB.classList.contains("true")) {
            boutonB.style.backgroundColor = "green";
        } else {
            boutonB.style.backgroundColor = "red";
        }

        if(reponseC.classList.contains("true")) {
            boutonC.style.backgroundColor = "green";
        } else {
            boutonC.style.backgroundColor = "red";
        }
    };

    function rafraichirFeedback()
    {
        boutonA.style.backgroundColor = "white";
        boutonB.style.backgroundColor = "white";
        boutonC.style.backgroundColor = "white";
    }

    function prochaineEnigme()
    {
        fetch('/suivant', {
            method: 'post',
            headers: { 'Content-Type': 'application/json' },
        })
        .then(res => res.json())
        .then(json => rafraichirVue(json))
    };


    function repondre(event)
    {
        if(enAttente) 
        {
            console.log("REPONSE: en attente");
            return;
        }

        enAttente = true;

        var reponse = event.currentTarget.valeur;
        console.log("REPONSE: " + reponse);
        
        feedback();

        removeListeners();

        setTimeout(() => {

            prochaineEnigme();
            enAttente = false;
            
        }, tempsAttente);
    };

    //socket.io    
    const socket = io();

    socket.on('capteur', function(capteur) {
        console.log("[EVENT] capteur: " + capteur);

        if(capteur == "A")
        {
            reponseA.click();
        } else if(capteur == "B")
        {
            reponseB.click();
        } else if(capteur == "C")
        {
            reponseC.click();
        } else {
            console.log("[EVENT] Erreur, capteur non reconnu");
        }
    });

</script>
